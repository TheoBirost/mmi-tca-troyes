name: s5_Theo-bi-symfony

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 📥 Récupération du dépôt
      - name: Checkout repository
        uses: actions/checkout@v4

      # ⚙️ Installation PHP et Composer
      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, curl, zip, bcmath, intl
          tools: composer

      # 📦 Installation des dépendances (dev + prod pour tests)
      - name: Install dependencies (dev)
        run: composer install --no-interaction --prefer-dist

      # ✅ Lint + Tests unitaires + Sécurité (déjà faits précédemment)
      - name: Run lint
        run: composer lint

      - name: Run tests
        run: composer test

      - name: Run security check
        run: composer audit || true

      # 🎯 Dump ENV pour la prod
      - name: Dump environment variables for production
        run: composer dump-env prod
        env:
          APP_ENV: prod
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      # 📦 Installer uniquement les dépendances de production
      - name: Install production dependencies
        run: composer install --no-dev --optimize-autoloader --ignore-platform-reqs

      # 🎨 Compiler les assets
      - name: Compile assets
        run: php bin/console asset-map:compile

      # 📂 Créer l’archive de l’artefact
      - name: Create Symfony artifact
        run: |
          tar -czvf symfony-artifact-r1.tar.gz \
              --exclude=.git \
              --exclude=node_modules \
              --exclude=var/cache \
              --exclude=var/log \
              --exclude=tests \
              --exclude=.env \
              --exclude=docker \
              --exclude=docker-compose.yml \
              --exclude=README.md \
              --exclude=*.log \
              --exclude=*.gitignore \
              .

      # 📤 Upload de l’artefact sur GitHub
      - name: Upload Symfony artifact
        uses: actions/upload-artifact@v4
        with:
          name: symfony-artifact
          path: symfony-artifact-r1.tar.gz
