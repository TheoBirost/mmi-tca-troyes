# Nom du workflow
name: s5-Theo-bi-symfony

# Déclencheurs du workflow
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-artifact:
    runs-on: ubuntu-latest

    steps:
      # 1. Récupération du code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Configuration de PHP
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, curl, zip, bcmath, intl, ctype
          tools: composer:v2

      # 3. Installation des dépendances PHP
      - name: Install PHP dependencies
        working-directory: ./ressources/s5/Theo-bi/projets/ci-cd-symfony
        run: composer install --no-dev --optimize-autoloader --ignore-platform-reqs

      # 4. Création du fichier .env.local.php
      - name: Dump environment variables for production
        working-directory: ./ressources/s5/Theo-bi/projets/ci-cd-symfony
        run: composer dump-env prod
        env:
          APP_ENV: prod
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      # 5. Installation des dépendances JavaScript via ImportMap
      # ✅ NOUVELLE ÉTAPE : C'est ici que la magie opère !
      - name: Install JavaScript assets via ImportMap
        working-directory: ./ressources/s5/Theo-bi/projets/ci-cd-symfony
        run: php bin/console importmap:install

      # 6. Compilation des assets
      - name: Compile assets with AssetMapper
        working-directory: ./ressources/s5/Theo-bi/projets/ci-cd-symfony
        run: php bin/console asset-map:compile

      # 7. Création de l'archive de l'artefact
      - name: Create Artifact Archive
        working-directory: ./ressources/s5/Theo-bi/projets/ci-cd-symfony
        run: |
          tar -czvf ../../../../../symfony-artifact.tar.gz \
            --exclude=.git \
            --exclude=.github \
            --exclude=node_modules \
            --exclude=var/cache/* \
            --exclude=var/log/* \
            --exclude=tests \
            --exclude=.env \
            --exclude=docker \
            --exclude=docker-compose.yml \
            --exclude=README.md \
            --exclude=*.log \
            --exclude=*.gitignore \
            --exclude=composer.lock \
            .

      # 8. Upload de l'artefact
      - name: Upload artifact for deployment jobs
        uses: actions/upload-artifact@v4
        with:
          name: symfony-artifact-r1
          path: symfony-artifact-r1.tar.gz