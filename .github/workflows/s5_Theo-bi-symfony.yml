name: s5_Theo-bi-symfony

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # ğŸ“¥ RÃ©cupÃ©ration du dÃ©pÃ´t
      - name: Checkout repository
        uses: actions/checkout@v4

      # âš™ï¸ Installation PHP et Composer
      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, curl, zip, bcmath, intl
          tools: composer

      # ğŸ“¦ Installation des dÃ©pendances (dev + prod pour tests)
      - name: Install dependencies (dev)
        run: composer install --no-interaction --prefer-dist

      # âœ… Lint + Tests unitaires + SÃ©curitÃ© (dÃ©jÃ  faits prÃ©cÃ©demment)
      - name: Run lint
        run: composer lint

      - name: Run tests
        run: composer test

      - name: Run security check
        run: composer audit || true

      # ğŸ¯ Dump ENV pour la prod
      - name: Dump environment variables for production
        run: composer dump-env prod
        env:
          APP_ENV: prod
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      # ğŸ“¦ Installer uniquement les dÃ©pendances de production
      - name: Install production dependencies
        run: composer install --no-dev --optimize-autoloader --ignore-platform-reqs

      # ğŸ¨ Compiler les assets
      - name: Compile assets
        run: php bin/console asset-map:compile

      # ğŸ“‚ CrÃ©er lâ€™archive de lâ€™artefact
      - name: Create Symfony artifact
        run: |
          tar -czvf symfony-artifact-r1.tar.gz \
              --exclude=.git \
              --exclude=node_modules \
              --exclude=var/cache \
              --exclude=var/log \
              --exclude=tests \
              --exclude=.env \
              --exclude=docker \
              --exclude=docker-compose.yml \
              --exclude=README.md \
              --exclude=*.log \
              --exclude=*.gitignore \
              .

      # ğŸ“¤ Upload de lâ€™artefact sur GitHub
      - name: Upload Symfony artifact
        uses: actions/upload-artifact@v4
        with:
          name: symfony-artifact
          path: symfony-artifact-r1.tar.gz
